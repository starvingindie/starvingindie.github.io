var Player,blockToAction,blockToScene,conditionsMet,extractBlocks,getBlockType,matchAnchor,matchAnchors,matchHref,normalize,parseBlocks,parseText,regexLib,splitAltText,toBoolHash,trimText;parseText=function(a){var b,c,d;return c=a.split(/\n|\r\n/),b=extractBlocks(c),d=parseBlocks(b)},getBlockType=function(a){switch(a){case 1:return"story";case 2:return"scene";case 3:return"action"}},extractBlocks=function(a){var b,c,d,e,f,g;for(b=[],c=null,f=0,g=a.length;g>f;f++)d=a[f],e=d.match(/^(#{1,3})\s+([^#].*)$/),null!=e?(null!==c&&b.push(c),c={type:getBlockType(e[1].length),name:e[2],lines:[]}):c.lines.push(d);return null!==c&&b.push(c),b},parseBlocks=function(a){var b,c,d,e,f,g,h,i,j,k,l;for(f=null,i=0,k=a.length;k>i;i++)if(c=a[i],"story"===c.type){f=c;break}for(h=matchAnchor(f.name),g=matchHref(h.href),e={name:h.text,description:trimText(f.lines.join("\n")),firstScene:g.target,scenes:{},actions:{}},j=0,l=a.length;l>j;j++)switch(c=a[j],c.type){case"scene":d=blockToScene(c),e.scenes[d.key]||(e.scenes[d.key]=[]),e.scenes[d.key].push(d);break;case"action":b=blockToAction(c),e.actions[b.state]=b}return e},blockToScene=function(a){var b,c,d,e,f,g;return f=matchAnchor(a.name),null!=f?(g=trimText(null!=f.title?f.title:f.text),d=normalize(f.text),c=matchHref(f.href),null!=(null!=c?c.conditions:void 0)&&(b=toBoolHash(c.conditions.split("&")))):(g=trimText(a.name),d=normalize(a.name)),e={name:g,key:d,description:trimText(a.lines.join("\n")),conditions:null!=b?b:null}},blockToAction=function(a){var b;return b={state:normalize(a.name),description:trimText(a.lines.join("\n"))}},Player=function(){function a(a,b){var c,d,e,f,g,h,i;this.story=a,this.id=b,this.converter=new Markdown.Converter,this.container=$("#"+this.id),this.container.addClass("ficdown").data("player",this),this.playerState={},this.visitedScenes={},this.currentScene=null,this.moveCounter=0,c=0,i=this.story.scenes;for(d in i)for(f=i[d],g=0,h=f.length;h>g;g++)e=f[g],e.id="s"+ ++c}return a.prototype.play=function(){return this.container.html(this.converter.makeHtml("#"+this.story.name+"\n\n"+this.story.description+"\n\n[Click to start...](/"+this.story.firstScene+")")),this.wireLinks()},a.prototype.wireLinks=function(){return this.container.find("a:not(.disabled):not(.external)").each(function(a){var b;return b=$(this),null==b.attr("href").match(/^https?:\/\//)?b.click(function(){var a;return b.addClass("chosen"),a=b.parents(".ficdown").data("player"),a.handleHref(b.attr("href")),!1}):b.addClass("external")})},a.prototype.resolveDescription=function(a){var b,c,d,e,f,g,h,i,j,k;for(k=matchAnchors(a),i=0,j=k.length;j>i;i++)c=k[i],e=matchHref(c.href),null!=e.conditions&&(d=toBoolHash(e.conditions.split("&")),h=conditionsMet(this.playerState,d),b=splitAltText(c.text),g=h?b.passed:b.failed,null==g&&(g=""),g=g.replace(regexLib.escapeChar,""),""===g||null==e.toggles&&null==e.target?a=a.replace(c.anchor,g):(f="["+g+"]("+(null!=e.target?"/"+e.target:"")+(null!=e.toggles?"#"+e.toggles:"")+")",a=a.replace(c.anchor,f)));return a=a.replace(regexLib.emptyListItem,"")},a.prototype.disableOldLinks=function(){return this.container.find("a:not(.external)").each(function(a){var b;return b=$(this),b.addClass("disabled"),b.unbind("click"),b.click(function(){return!1})})},a.prototype.processHtml=function(a,b){var c;return c=$("<div/>").append($.parseHTML(b)),this.visitedScenes[a]?c.find("blockquote").remove():c.find("blockquote").each(function(a){var b;return b=$(this),b.replaceWith(b.html())}),c.html()},a.prototype.checkGameOver=function(){return 0===this.container.find("a:not(.disabled):not(.external)").length?(this.container.append(this.converter.makeHtml('## The End\n\nYou have reached the end of this story. <a id="restart" href="">Click here</a> to start over.')),$("#restart").data("info",[this.id,this.story]).click(function(){var b,c;return b=$(this).data("info"),$("#"+b[0]).empty(),c=new a(b[1],b[0]),$("#"+b[0]).data("player",c),c.play(),!1})):void 0},a.prototype.handleHref=function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s;if(d=matchHref(a),e=null,c=[],null!=(null!=d?d.toggles:void 0))for(l=d.toggles.split("+"),m=0,p=l.length;p>m;m++)k=l[m],null!=this.story.actions[k]&&(b=$.extend({},this.story.actions[k]),b.description=this.resolveDescription(b.description),c.push(b)),this.playerState[k]=!0;if(null!=(null!=d?d.target:void 0)&&null!=this.story.scenes[d.target])for(s=this.story.scenes[d.target],n=0,q=s.length;q>n;n++)i=s[n],conditionsMet(this.playerState,i.conditions)&&(null==e||null==i.conditions||null==e.conditions||Object.keys(i.conditions).length>Object.keys(e.conditions).length)&&(e=i);for(null!=e&&(this.currentScene=e),h=$.extend({},this.currentScene),h.description=this.resolveDescription(h.description),this.disableOldLinks(),f="##"+h.name+"\n\n",o=0,r=c.length;r>o;o++)b=c[o],f+=""+b.description+"\n\n";return f+=h.description,g=this.processHtml(h.id,this.converter.makeHtml(f)),this.visitedScenes[h.id]=!0,j="move-"+this.moveCounter++,this.container.append($("<span/>").attr("id",j)),this.container.append(g),this.wireLinks(),this.checkGameOver(),this.container.parent(".container").animate({scrollTop:$("#"+j).offset().top-this.container.offset().top},1e3)},a}(),regexLib={anchors:/(\[((?:[^\[\]]+|\[(?:[^\[\]]+|\[(?:[^\[\]]+|\[(?:[^\[\]]+|\[(?:[^\[\]]+|\[(?:[^\[\]]+|\[\])*\])*\])*\])*\])*\])*)\]\([ ]*((?:[^()\s]+|\((?:[^()\s]+|\((?:[^()\s]+|\((?:[^()\s]+|\((?:[^()\s]+|\((?:[^()\s]+|\(\))*\))*\))*\))*\))*\))*)[ ]*((['"])(.*?)\5[ ]*)?\))/gm,href:/^(?:\/([a-zA-Z](?:-?[a-zA-Z0-9])*))?(?:\?((?:!?[a-zA-Z](?:-?[a-zA-Z0-9])*)(?:&!?[a-zA-Z](?:-?[a-zA-Z0-9])*)*)?)?(?:#((?:[a-zA-Z](?:-?[a-zA-Z0-9])*)(?:\+[a-zA-Z](?:-?[a-zA-Z0-9])*)*))?$/,trim:/^\s+|\s+$/g,altText:/^((?:[^|\\]|\\.)*)(?:\|((?:[^|\\]|\\.)+))?$/,escapeChar:/\\(?=[^\\])/g,emptyListItem:/^[ ]*-\s*([\r\n]+|$)/gm},matchAnchor=function(a){var b,c,d;return c=new RegExp(regexLib.anchors),b=c.exec(a),null!=b?(d={anchor:b[1],text:b[2],href:b[3],title:b[6]},0===d.href.indexOf('"')&&(d.title=d.href.substring(1,d.href.length-1),d.href=""),d):b},matchAnchors=function(a){var b,c,d,e;for(e=new RegExp(regexLib.anchors),c=[];d=e.exec(a);)b={anchor:d[1],text:d[2],href:d[3],title:d[6]},0===b.href.indexOf('"')&&(b.title=b.href.substring(1,b.href.length-1),b.href=""),c.push(b);return c},trimText=function(a){return a.replace(regexLib.trim,"")},matchHref=function(a){var b,c,d;return c=new RegExp(regexLib.href),b=c.exec(a),null!=b?d={target:b[1],conditions:b[2],toggles:b[3]}:b},normalize=function(a){return a.toLowerCase().replace(/^\W+|\W+$/g,"").replace(/\W+/g,"-")},toBoolHash=function(a){var b,c,d,e;if(null==a)return null;for(b={},d=0,e=a.length;e>d;d++)c=a[d],0===c.indexOf("!")?b[c.substring(1,c.length)]=!1:b[c]=!0;return b},conditionsMet=function(a,b){var c,d,e;d=!0;for(c in b)if(e=b[c],e&&!a[c]||!e&&a[c]){d=!1;break}return d},splitAltText=function(a){var b,c,d;return c=new RegExp(regexLib.altText),b=c.exec(a),null!=b?d={passed:b[1],failed:b[2]}:void 0};